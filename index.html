<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kho Hội Thoại Song Ngữ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ...giữ nguyên phần style như bạn đã gửi... */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .conversation-card { transition: all 0.3s ease; }
        .conversation-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .dialogue-line { margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; border-left: 4px solid #e5e7eb; }
        .dialogue-line.speaker-a { background-color: #eff6ff; border-left-color: #3b82f6; }
        .dialogue-line.speaker-b { background-color: #f0fdf4; border-left-color: #10b981; }
        .dialogue-input { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 1001; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ...giữ nguyên phần HTML như bạn đã gửi... -->
    <!-- (giữ nguyên phần header, main, modals...) -->
    <!-- ... -->

    <script>
        // Global variables
        let conversations = [];
        let editingId = null;
        let currentFilter = { search: '', category: '', difficulty: '' };
        let currentDialogue = { english: [], vietnamese: [] };

        const sampleData = [
            {
                id: 1,
                title: "Giới thiệu bản thân",
                category: "Giao tiếp cơ bản",
                tags: ["introduction", "basic", "greeting"],
                difficulty: "beginner",
                speakerA: "John",
                speakerB: "Mary",
                englishDialogue: [
                    { speaker: "John", text: "Hi, my name is John. Nice to meet you!" },
                    { speaker: "Mary", text: "Hello John! I'm Mary. Nice to meet you too!" },
                    { speaker: "John", text: "Where are you from, Mary?" },
                    { speaker: "Mary", text: "I'm from Vietnam. How about you?" },
                    { speaker: "John", text: "I'm from the United States. What do you do?" },
                    { speaker: "Mary", text: "I'm a software developer. And you?" },
                    { speaker: "John", text: "I'm a teacher. It's great to meet you!" }
                ],
                vietnameseDialogue: [
                    { speaker: "John", text: "Xin chào, tôi tên là John. Rất vui được gặp bạn!" },
                    { speaker: "Mary", text: "Chào John! Tôi là Mary. Tôi cũng rất vui được gặp bạn!" },
                    { speaker: "John", text: "Bạn đến từ đâu vậy Mary?" },
                    { speaker: "Mary", text: "Tôi đến từ Việt Nam. Còn bạn thì sao?" },
                    { speaker: "John", text: "Tôi đến từ Hoa Kỳ. Bạn làm nghề gì?" },
                    { speaker: "Mary", text: "Tôi là lập trình viên. Còn bạn?" },
                    { speaker: "John", text: "Tôi là giáo viên. Rất vui được gặp bạn!" }
                ],
                createdAt: "2024-05-01"
            },
            {
                id: 2,
                title: "Đặt món ăn tại nhà hàng",
                category: "Nhà hàng",
                tags: ["food", "restaurant", "ordering"],
                difficulty: "intermediate",
                speakerA: "Customer",
                speakerB: "Waiter",
                englishDialogue: [
                    { speaker: "Waiter", text: "Good evening! Welcome to our restaurant. How many people?" },
                    { speaker: "Customer", text: "Good evening! Table for two, please." },
                    { speaker: "Waiter", text: "Right this way. Here's your menu." },
                    { speaker: "Customer", text: "Thank you. Could I have a bowl of pho, please?" },
                    { speaker: "Waiter", text: "Of course! Would you like it with beef or chicken?" },
                    { speaker: "Customer", text: "Beef, please. And could you make it less spicy?" },
                    { speaker: "Waiter", text: "No problem. Anything to drink?" },
                    { speaker: "Customer", text: "Just water, thank you." }
                ],
                vietnameseDialogue: [
                    { speaker: "Waiter", text: "Chào buổi tối! Chào mừng đến nhà hàng. Mấy người ạ?" },
                    { speaker: "Customer", text: "Chào buổi tối! Bàn cho hai người." },
                    { speaker: "Waiter", text: "Mời bạn đi theo. Đây là thực đơn ạ." },
                    { speaker: "Customer", text: "Cảm ơn. Cho tôi một tô phở được không?" },
                    { speaker: "Waiter", text: "Dạ được ạ! Bạn muốn phở bò hay phở gà?" },
                    { speaker: "Customer", text: "Phở bò. Và làm ơn làm ít cay hơn." },
                    { speaker: "Waiter", text: "Dạ không sao ạ. Bạn uống gì không?" },
                    { speaker: "Customer", text: "Chỉ nước lọc thôi, cảm ơn." }
                ],
                createdAt: "2024-05-02"
            }
        ];

        // Khởi tạo app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderConversations();
            updateStatistics();
            updateCategoryFilter();
        });

        // Data management
        function loadData() {
            const savedData = localStorage.getItem('bilingual_conversations');
            if (savedData) {
                conversations = JSON.parse(savedData);
            } else {
                conversations = sampleData;
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('bilingual_conversations', JSON.stringify(conversations));
        }

        // Modal management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'addModal') {
                resetForm();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            if (modalId === 'addModal') {
                editingId = null;
                resetForm();
            }
        }

        // Form management
        function resetForm() {
            document.getElementById('conversationForm').reset();
            document.getElementById('modalTitle').textContent = editingId ? 'Chỉnh Sửa Hội Thoại' : 'Thêm Hội Thoại Mới';
            document.getElementById('saveButtonText').textContent = editingId ? 'Cập Nhật' : 'Lưu';
            currentDialogue = { english: [], vietnamese: [] };
            renderDialogueBuilder();
            updateSpeakerOptions();
        }

        // Dialogue management
        function addDialogueLine(language) {
            const speakerSelect = document.getElementById(language + 'Speaker');
            const lineInput = document.getElementById(language + 'Line');
            const speaker = speakerSelect.value;
            const text = lineInput.value.trim();
            if (!text) {
                showNotification('Vui lòng nhập nội dung câu nói!', 'error');
                return;
            }
            currentDialogue[language].push({ speaker, text });
            lineInput.value = '';
            renderDialogueBuilder();
        }

        function removeDialogueLine(language, index) {
            currentDialogue[language].splice(index, 1);
            renderDialogueBuilder();
        }

        function clearDialogue() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ hội thoại?')) {
                currentDialogue = { english: [], vietnamese: [] };
                renderDialogueBuilder();
            }
        }

        function renderDialogueBuilder() {
            renderDialogueLines('english');
            renderDialogueLines('vietnamese');
        }

        function renderDialogueLines(language) {
            const container = document.getElementById(language + 'Dialogue');
            const lines = currentDialogue[language];
            const speakerA = document.getElementById('speakerA').value || 'A';
            container.innerHTML = lines.map((line, index) => `
                <div class="dialogue-line speaker-${line.speaker === speakerA ? 'a' : 'b'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <strong class="text-sm font-medium">${line.speaker}:</strong>
                            <span class="ml-2">${line.text}</span>
                        </div>
                        <button type="button" onclick="removeDialogueLine('${language}', ${index})" class="ml-2 text-red-500 hover:text-red-700">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateSpeakerOptions() {
            const speakerA = document.getElementById('speakerA').value || 'A';
            const speakerB = document.getElementById('speakerB').value || 'B';
            ['english', 'vietnamese'].forEach(lang => {
                const select = document.getElementById(lang + 'Speaker');
                select.innerHTML = `
                    <option value="${speakerA}">${speakerA}</option>
                    <option value="${speakerB}">${speakerB}</option>
                `;
            });
        }

        document.addEventListener('input', function(e) {
            if (e.target.id === 'speakerA' || e.target.id === 'speakerB') {
                updateSpeakerOptions();
            }
        });

        function saveConversation(event) {
            event.preventDefault();
            if (currentDialogue.english.length === 0 || currentDialogue.vietnamese.length === 0) {
                showNotification('Vui lòng thêm ít nhất một câu hội thoại cho mỗi ngôn ngữ!', 'error');
                return;
            }
            const formData = {
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                difficulty: document.getElementById('difficulty').value,
                speakerA: document.getElementById('speakerA').value || 'A',
                speakerB: document.getElementById('speakerB').value || 'B',
                englishDialogue: [...currentDialogue.english],
                vietnameseDialogue: [...currentDialogue.vietnamese],
                createdAt: new Date().toISOString().split('T')[0]
            };
            if (editingId) {
                const index = conversations.findIndex(conv => conv.id === editingId);
                conversations[index] = { ...conversations[index], ...formData };
            } else {
                const newConversation = {
                    id: Date.now(),
                    ...formData
                };
                conversations.push(newConversation);
            }
            saveData();
            renderConversations();
            updateStatistics();
            updateCategoryFilter();
            closeModal('addModal');
            showNotification(editingId ? 'Đã cập nhật hội thoại!' : 'Đã thêm hội thoại mới!', 'success');
        }

        function editConversation(id) {
            const conversation = conversations.find(conv => conv.id === id);
            if (!conversation) return;
            editingId = id;
            document.getElementById('title').value = conversation.title;
            document.getElementById('category').value = conversation.category;
            document.getElementById('tags').value = conversation.tags.join(', ');
            document.getElementById('difficulty').value = conversation.difficulty;
            document.getElementById('speakerA').value = conversation.speakerA;
            document.getElementById('speakerB').value = conversation.speakerB;
            currentDialogue = {
                english: conversation.englishDialogue.map(line => ({ ...line })),
                vietnamese: conversation.vietnameseDialogue.map(line => ({ ...line }))
            };
            renderDialogueBuilder();
            updateSpeakerOptions();
            document.getElementById('modalTitle').textContent = 'Chỉnh Sửa Hội Thoại';
            document.getElementById('saveButtonText').textContent = 'Cập Nhật';
            openModal('addModal');
        }

        function deleteConversation(id) {
            if (confirm('Bạn có chắc chắn muốn xóa hội thoại này?')) {
                conversations = conversations.filter(conv => conv.id !== id);
                saveData();
                renderConversations();
                updateStatistics();
                updateCategoryFilter();
                showNotification('Đã xóa hội thoại!', 'success');
            }
        }

        // Render conversations
        function renderConversations() {
            const list = document.getElementById('conversationsList');
            let filtered = conversations.filter(conv => {
                let match = true;
                if (currentFilter.search) {
                    const s = currentFilter.search.toLowerCase();
                    match = match && (
                        conv.title.toLowerCase().includes(s) ||
                        conv.category.toLowerCase().includes(s) ||
                        conv.tags.join(',').toLowerCase().includes(s) ||
                        conv.englishDialogue.some(line => line.text.toLowerCase().includes(s)) ||
                        conv.vietnameseDialogue.some(line => line.text.toLowerCase().includes(s))
                    );
                }
                if (currentFilter.category) {
                    match = match && conv.category === currentFilter.category;
                }
                if (currentFilter.difficulty) {
                    match = match && conv.difficulty === currentFilter.difficulty;
                }
                return match;
            });
            document.getElementById('displayCount').textContent = filtered.length;
            if (filtered.length === 0) {
                list.innerHTML = '';
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }
            list.innerHTML = filtered.map(conv => `
                <div class="bg-white rounded-lg shadow conversation-card fade-in p-6">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${conv.title}</h3>
                            <div class="text-sm text-gray-500">${conv.category} · ${conv.difficulty === 'beginner' ? 'Cơ bản' : conv.difficulty === 'intermediate' ? 'Trung bình' : 'Nâng cao'}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editConversation(${conv.id})" class="text-blue-600 hover:text-blue-800" title="Sửa"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteConversation(${conv.id})" class="text-red-600 hover:text-red-800" title="Xóa"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mb-2">
                        ${conv.tags.map(tag => `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">${tag}</span>`).join('')}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="font-semibold text-gray-700 mb-1">${conv.speakerA} & ${conv.speakerB} (EN):</div>
                            ${conv.englishDialogue.map(line => `<div class="text-sm mb-1"><span class="font-bold">${line.speaker}:</span> ${line.text}</div>`).join('')}
                        </div>
                        <div>
                            <div class="font-semibold text-gray-700 mb-1">${conv.speakerA} & ${conv.speakerB} (VI):</div>
                            ${conv.vietnameseDialogue.map(line => `<div class="text-sm mb-1"><span class="font-bold">${line.speaker}:</span> ${line.text}</div>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Search/filter
        function filterConversations() {
            currentFilter.search = document.getElementById('searchInput').value.trim();
            currentFilter.category = document.getElementById('categoryFilter').value;
            currentFilter.difficulty = document.getElementById('difficultyFilter').value;
            renderConversations();
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('totalCount').textContent = conversations.length;
            const categories = new Set(conversations.map(c => c.category));
            document.getElementById('categoryCount').textContent = categories.size;
            const tags = new Set(conversations.flatMap(c => c.tags));
            document.getElementById('tagCount').textContent = tags.size;
            // displayCount được cập nhật trong renderConversations
        }

        // Update category filter
        function updateCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            const categories = Array.from(new Set(conversations.map(c => c.category)));
            select.innerHTML = '<option value="">Tất cả chủ đề</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Export/import
        function exportData() {
            const blob = new Blob([JSON.stringify(conversations, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bilingual_conversations.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Đã xuất dữ liệu!', 'success');
        }

        function importData() {
            const input = document.getElementById('importFile');
            if (!input.files.length) {
                showNotification('Vui lòng chọn file JSON!', 'error');
                return;
            }
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error();
                    conversations = data;
                    saveData();
                    renderConversations();
                    updateStatistics();
                    updateCategoryFilter();
                    closeModal('importModal');
                    showNotification('Đã nhập dữ liệu thành công!', 'success');
                } catch {
                    showNotification('File không hợp lệ!', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Notification
        function showNotification(message, type = 'info') {
            const noti = document.createElement('div');
            noti.className = `notification ${type}`;
            noti.textContent = message;
            document.body.appendChild(noti);
            setTimeout(() => {
                noti.remove();
            }, 2000);
        }

        // Gán filter cho input
        document.getElementById('searchInput').addEventListener('input', filterConversations);
        document.getElementById('categoryFilter').addEventListener('change', filterConversations);
        document.getElementById('difficultyFilter').addEventListener('change', filterConversations);

    </script>
</body>
</html>
